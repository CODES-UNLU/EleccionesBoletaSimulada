<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“Š Dashboard de VotaciÃ³n - UNLu 2025</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 25px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      text-align: center;
    }

    .header h1 {
      color: #667eea;
      font-size: 36px;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
      font-size: 16px;
    }

    .config-card {
      background: white;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 25px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    }

    .config-card h2 {
      color: #667eea;
      margin-bottom: 15px;
    }

    .config-card input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 15px;
      transition: border 0.3s;
    }

    .config-card input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      margin-top: 15px;
      border-radius: 5px;
    }

    .info-box p {
      color: #1565c0;
      font-size: 14px;
      line-height: 1.6;
      margin: 5px 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }

    .stat-label {
      color: #999;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #333;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 25px;
      margin-bottom: 25px;
    }

    .chart-card {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    .chart-card h2 {
      color: #333;
      font-size: 20px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .chart-container {
      position: relative;
      height: 300px;
    }

    .table-card {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    th, td {
      padding: 15px;
      text-align: left;
    }

    th {
      font-weight: 600;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 1px;
    }

    tbody tr {
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s ease;
    }

    tbody tr:hover {
      background: #f8f9fa;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }

    .error {
      background: #fee;
      border: 2px solid #f88;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      color: #c33;
      white-space: pre-wrap;
      line-height: 1.6;
    }

    .success {
      background: #e8f5e9;
      border: 2px solid #4caf50;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      color: #2e7d32;
    }

    .last-update {
      text-align: center;
      color: white;
      font-size: 14px;
      margin-top: 15px;
      opacity: 0.9;
    }

    .progress-bar {
      background: #e0e0e0;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 5px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.5s ease;
    }

    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }

      .header h1 {
        font-size: 24px;
      }

      .stat-value {
        font-size: 28px;
      }
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>ğŸ“Š Dashboard de VotaciÃ³n UNLu 2025</h1>
      <p>Lista 110 - EstadÃ­sticas en Tiempo Real</p>
      <button class="btn-primary" onclick="cargarDatos()" id="btnRefresh" style="margin-top: 15px;">
        ğŸ”„ Actualizar Datos
      </button>
      <p class="last-update" id="lastUpdate"></p>
    </div>

    <!-- ConfiguraciÃ³n (Oculta por defecto si hay URL preconfigurada) -->
    <div class="config-card hidden" id="configCard">
      <h2>âš™ï¸ ConfiguraciÃ³n Inicial</h2>
      <p style="color: #666; margin-bottom: 15px;">
        Pega aquÃ­ la URL de tu Google Apps Script (Web App)
      </p>
      
      <input 
        type="text" 
        id="scriptUrl" 
        placeholder="https://script.google.com/macros/s/TU_SCRIPT_ID/exec"
      >
      
      <button class="btn-primary" onclick="guardarConfiguracion()">
        ğŸ’¾ Guardar y Cargar Datos
      </button>

      <div class="info-box">
        <p><strong>ğŸ“‹ Pasos para obtener la URL:</strong></p>
        <p>1. Abre tu Google Sheet</p>
        <p>2. Ve a: <strong>Extensiones â†’ Apps Script</strong></p>
        <p>3. Copia y pega el cÃ³digo que te proporcionÃ©</p>
        <p>4. Click en <strong>"Implementar" â†’ "Nueva implementaciÃ³n"</strong></p>
        <p>5. Tipo: <strong>"AplicaciÃ³n web"</strong></p>
        <p>6. Ejecutar como: <strong>"Yo"</strong></p>
        <p>7. QuiÃ©n tiene acceso: <strong>"Cualquier usuario"</strong></p>
        <p>8. Click <strong>"Implementar"</strong></p>
        <p>9. <strong>Copia la URL</strong> y pÃ©gala aquÃ­ â†‘</p>
      </div>
    </div>

    <!-- Loading -->
    <div id="loadingDiv" class="loading hidden">
      <h2>â³ Cargando datos...</h2>
    </div>

    <!-- Error -->
    <div id="errorDiv" class="error hidden"></div>

    <!-- Success -->
    <div id="successDiv" class="success hidden"></div>

    <!-- EstadÃ­sticas -->
    <div id="statsSection" class="hidden">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">âœ…</div>
          <div class="stat-label">Total de Votos (Tildes)</div>
          <div class="stat-value" id="totalVotos">0</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">ğŸ“‹</div>
          <div class="stat-label">Votos Lista Completa</div>
          <div class="stat-value" id="votosListaCompleta">0</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">ğŸ¯</div>
          <div class="stat-label">Votos por Cargo</div>
          <div class="stat-value" id="votosCargo">0</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">ğŸ‘¥</div>
          <div class="stat-label">Votos de FÃ³rmulas</div>
          <div class="stat-value" id="votosFormulas">0</div>
        </div>
      </div>

      <!-- EstadÃ­sticas secundarias -->
      <div class="stats-grid" style="margin-top: 20px;">
        <div class="stat-card">
          <div class="stat-icon">ğŸ“Š</div>
          <div class="stat-label">Listas Participantes</div>
          <div class="stat-value" id="totalListas">0</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">ğŸ“</div>
          <div class="stat-label">Sedes Activas</div>
          <div class="stat-value" id="totalSedes">0</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">ğŸ†</div>
          <div class="stat-label">Lista LÃ­der</div>
          <div class="stat-value" id="listaLider" style="font-size: 24px;">-</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">â±ï¸</div>
          <div class="stat-label">Ãšltima ActualizaciÃ³n</div>
          <div class="stat-value" id="ultimaActualizacion" style="font-size: 16px;">-</div>
        </div>
      </div>

      <!-- GrÃ¡ficos -->
      <div class="charts-grid">
        <div class="chart-card">
          <h2>ğŸ“Š Tipo de Voto</h2>
          <div class="chart-container">
            <canvas id="chartListas"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <h2>ğŸ“ Votos por Sede</h2>
          <div class="chart-container">
            <canvas id="chartSedes"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <h2>ğŸ¯ Votos por Cargo</h2>
          <div class="chart-container">
            <canvas id="chartCargos"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <h2>ğŸ“ˆ Actividad por Hora</h2>
          <div class="chart-container">
            <canvas id="chartTemporal"></canvas>
          </div>
        </div>
      </div>

      <!-- Tabla Detallada -->
      <div class="table-card">
        <h2 style="color: #333; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;">
          ğŸ“‹ Votos por Lista Completa y FÃ³rmulas
        </h2>
        <table>
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Lista / FÃ³rmula</th>
              <th>Votos</th>
              <th>Porcentaje</th>
              <th>Progreso</th>
            </tr>
          </thead>
          <tbody id="tableBody">
          </tbody>
        </table>
      </div>

      <!-- Tabla Cruzada: Lista x Cargo -->
      <div class="table-card" style="margin-top: 25px;">
        <h2 style="color: #333; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;">
          ğŸ“Š DistribuciÃ³n de Votos por Lista y Cargo
        </h2>
        <div style="overflow-x: auto;">
          <table id="tableCruzada">
            <thead id="tableCruzadaHead">
              <tr>
                <th style="min-width: 150px;">Lista / AgrupaciÃ³n</th>
              </tr>
            </thead>
            <tbody id="tableCruzadaBody">
            </tbody>
          </table>
        </div>
      </div>

      <!-- GrÃ¡fico de Barras Agrupadas -->
      <div class="chart-card" style="margin-top: 25px;">
        <h2>ğŸ“Š Votos por Lista en cada Cargo</h2>
        <div class="chart-container large">
          <canvas id="chartListaPorCargo"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIGURACIÃ“N Y ESTADO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // âš ï¸ CONFIGURACIÃ“N: Pega aquÃ­ la URL de tu Google Apps Script
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwO9-KmhNnUtzAWyHUiaRUogni7DVcmu4EybQxjQtwnHXikbSVSZwP4B8llDRFQ86O0BA/exec'; // Reemplazar con: https://script.google.com/macros/s/.../exec
    
    let config = {
      scriptUrl: SCRIPT_URL || localStorage.getItem('scriptUrl') || ''
    };

    let charts = {};
    let datosActuales = null;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FUNCIONES DE CONFIGURACIÃ“N
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function guardarConfiguracion() {
      const url = document.getElementById('scriptUrl').value.trim();

      if (!url) {
        mostrarError('âš ï¸ Por favor ingresa la URL del Google Apps Script');
        return;
      }

      if (!url.includes('script.google.com')) {
        mostrarError('âš ï¸ La URL no parece ser de Google Apps Script.\n\nDebe contener: script.google.com');
        return;
      }

      config.scriptUrl = url;
      localStorage.setItem('scriptUrl', url);

      mostrarSuccess('âœ… ConfiguraciÃ³n guardada correctamente');
      
      // Cargar datos automÃ¡ticamente
      setTimeout(() => {
        cargarDatos();
      }, 1000);
    }

    function cargarConfiguracion() {
      if (config.scriptUrl) {
        document.getElementById('scriptUrl').value = config.scriptUrl;
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CARGA DE DATOS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function cargarDatos() {
      if (!config.scriptUrl) {
        mostrarError('âš™ï¸ Por favor configura primero la URL del Google Apps Script');
        return;
      }

      mostrarLoading(true);
      ocultarMensajes();

      try {
        console.log('ğŸ“Š Cargando datos desde:', config.scriptUrl);

        const response = await fetch(config.scriptUrl);
        
        if (!response.ok) {
          throw new Error(`Error ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        
        console.log('âœ… Datos recibidos:', data);

        if (!data.success) {
          throw new Error(data.error || 'Error desconocido');
        }

        if (!data.values || data.values.length === 0) {
          throw new Error('No hay datos en el Sheet.\n\nEjecuta "Inicializar Sistema" desde el menÃº del Sheet.');
        }

        datosActuales = data;
        procesarDatos(data.values);
        
        // Ocultar configuraciÃ³n y mostrar estadÃ­sticas
        document.getElementById('configCard').classList.add('hidden');
        document.getElementById('statsSection').classList.remove('hidden');
        
        // Actualizar timestamp
        document.getElementById('lastUpdate').textContent = 
          'Ãšltima actualizaciÃ³n: ' + new Date().toLocaleTimeString('es-AR');

        mostrarLoading(false);

      } catch (error) {
        console.error('âŒ Error:', error);
        mostrarError(
          'âŒ Error al cargar datos\n\n' +
          error.message + '\n\n' +
          'âœ… Verifica:\n' +
          '1. La URL del Script sea correcta\n' +
          '2. Hayas ejecutado "Inicializar Sistema" en el Sheet\n' +
          '3. El script estÃ© implementado como Web App\n' +
          '4. El acceso estÃ© configurado como "Cualquier usuario"'
        );
        mostrarLoading(false);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PROCESAMIENTO DE DATOS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function procesarDatos(valores) {
      // Primera fila = encabezados
      // [Timestamp, Sede, Tipo de Voto, Lista Completa, Cargo, Candidato Votado, AgrupaciÃ³n]
      const headers = valores[0];
      const filas = valores.slice(1);

      console.log('ğŸ“Š Procesando', filas.length, 'selecciones');

      // Contadores
      const stats = {
        totalVotos: filas.length,
        porSede: {},
        porTipoVoto: {},
        porListaCompleta: {},
        porCargo: {},
        porCandidato: {},
        porAgrupacion: {},
        porHora: {},
        combinaciones: []
      };

      // Crear objeto para datos cruzados: agrupacion x cargo
      const datosCruzados = {};

      // Procesar cada selecciÃ³n
      filas.forEach(fila => {
        const [timestamp, sede, tipoVoto, listaCompleta, cargo, candidato, agrupacion] = fila;

        // Contar por sede
        stats.porSede[sede] = (stats.porSede[sede] || 0) + 1;

        // Contar por tipo de voto
        stats.porTipoVoto[tipoVoto] = (stats.porTipoVoto[tipoVoto] || 0) + 1;

        // Contar por lista completa (si aplica)
        if (listaCompleta && listaCompleta !== '-') {
          stats.porListaCompleta[listaCompleta] = (stats.porListaCompleta[listaCompleta] || 0) + 1;
        }

        // Contar por cargo
        if (cargo && cargo !== '-') {
          stats.porCargo[cargo] = (stats.porCargo[cargo] || 0) + 1;
        }

        // Contar por candidato
        if (candidato && candidato !== '-') {
          stats.porCandidato[candidato] = (stats.porCandidato[candidato] || 0) + 1;
        }

        // Contar por agrupaciÃ³n
        if (agrupacion && agrupacion !== '-') {
          stats.porAgrupacion[agrupacion] = (stats.porAgrupacion[agrupacion] || 0) + 1;
        }

        // *** NUEVO: Datos cruzados AgrupaciÃ³n x Cargo ***
        if (agrupacion && agrupacion !== '-' && cargo && cargo !== '-' && cargo !== 'Todos los cargos') {
          if (!datosCruzados[agrupacion]) {
            datosCruzados[agrupacion] = {};
          }
          datosCruzados[agrupacion][cargo] = (datosCruzados[agrupacion][cargo] || 0) + 1;
        }

        // Extraer hora para grÃ¡fico temporal
        if (timestamp) {
          const hora = timestamp.substring(11, 13); // Extraer HH de HH:mm:ss
          stats.porHora[hora] = (stats.porHora[hora] || 0) + 1;
        }

        // Guardar combinaciÃ³n sede-tipo
        const key = `${sede}|${tipoVoto}`;
        const existente = stats.combinaciones.find(c => c.key === key);
        if (existente) {
          existente.votos++;
        } else {
          stats.combinaciones.push({ 
            key, 
            sede, 
            tipo: tipoVoto, 
            votos: 1 
          });
        }
      });

      // Agregar datos cruzados a stats
      stats.datosCruzados = datosCruzados;

      actualizarDashboard(stats);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ACTUALIZACIÃ“N DE DASHBOARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function actualizarDashboard(stats) {
      // ============================================================
      // ESTADÃSTICAS PRINCIPALES: CONTEO POR TIPO DE VOTO
      // ============================================================
      
      // Total de votos (tildes) emitidos
      document.getElementById('totalVotos').textContent = stats.totalVotos.toLocaleString();
      
      // Contar votos por tipo
      const votosListaCompleta = stats.porTipoVoto['Lista Completa'] || 0;
      const votosIndividuales = stats.porTipoVoto['Individual'] || 0;
      const votosFormulas = stats.porTipoVoto['FÃ³rmula'] || 0;
      
      document.getElementById('votosListaCompleta').textContent = votosListaCompleta.toLocaleString();
      document.getElementById('votosCargo').textContent = votosIndividuales.toLocaleString();
      document.getElementById('votosFormulas').textContent = votosFormulas.toLocaleString();
      
      // ============================================================
      // ESTADÃSTICAS SECUNDARIAS
      // ============================================================
      
      // Total de LISTAS (solo 110, 117, 101, 111) - NO incluir fÃ³rmulas
      const listasReales = Object.keys(stats.porAgrupacion).filter(agrup => 
        agrup.startsWith('Lista ') && !agrup.startsWith('FÃ³rmula')
      );
      const totalListas = listasReales.length || Object.keys(stats.porListaCompleta).length || 0;
      document.getElementById('totalListas').textContent = totalListas;
      
      document.getElementById('totalSedes').textContent = Object.keys(stats.porSede).length;

      // Lista mÃ¡s votada (solo listas reales, no fÃ³rmulas)
      const agrupacionesListas = Object.entries(stats.porAgrupacion)
        .filter(([nombre]) => nombre.startsWith('Lista ') && !nombre.startsWith('FÃ³rmula'))
        .sort((a, b) => b[1] - a[1]);
      
      if (agrupacionesListas.length > 0) {
        const [nombre, votos] = agrupacionesListas[0];
        const porcentaje = ((votos / stats.totalVotos) * 100).toFixed(1);
        document.getElementById('listaLider').textContent = `${nombre} (${porcentaje}%)`;
      } else {
        document.getElementById('listaLider').textContent = '-';
      }
      
      // Ãšltima actualizaciÃ³n
      const ahora = new Date();
      const horaFormateada = ahora.toLocaleTimeString('es-AR', {hour: '2-digit', minute: '2-digit'});
      document.getElementById('ultimaActualizacion').textContent = horaFormateada;

      // Crear grÃ¡ficos con nuevos datos
      crearGraficoTiposVoto(stats.porTipoVoto, stats.totalVotos);
      crearGraficoSedes(stats.porSede);
      crearGraficoCargos(stats.porCargo);
      crearGraficoTemporal(stats.porHora);

      // Crear tabla con candidatos
      crearTabla(stats, stats.totalVotos);

      // *** NUEVO: Tabla y grÃ¡fico cruzado ***
      crearTablaCruzada(stats.datosCruzados);
      crearGraficoListaPorCargo(stats.datosCruzados);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GRÃFICOS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function crearGraficoTiposVoto(data, total) {
      if (charts.listas) charts.listas.destroy();

      const ctx = document.getElementById('chartListas');
      const labels = Object.keys(data);
      const valores = Object.values(data);
      const colores = generarColores(labels.length);

      charts.listas = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: valores,
            backgroundColor: colores,
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const valor = context.parsed;
                  const porcentaje = ((valor / total) * 100).toFixed(1);
                  return `${context.label}: ${valor} selecciones (${porcentaje}%)`;
                }
              }
            }
          }
        }
      });
    }

    function crearGraficoSedes(data) {
      if (charts.sedes) charts.sedes.destroy();

      const ctx = document.getElementById('chartSedes');
      const labels = Object.keys(data);
      const valores = Object.values(data);

      charts.sedes = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Votos',
            data: valores,
            backgroundColor: 'rgba(102, 126, 234, 0.8)',
            borderColor: 'rgba(102, 126, 234, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { precision: 0 } }
          }
        }
      });
    }

    function crearGraficoCargos(data) {
      if (charts.cargos) charts.cargos.destroy();

      const ctx = document.getElementById('chartCargos');
      const labels = Object.keys(data);
      const valores = Object.values(data);

      charts.cargos = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Votos',
            data: valores,
            backgroundColor: 'rgba(118, 75, 162, 0.8)',
            borderColor: 'rgba(118, 75, 162, 1)',
            borderWidth: 2
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { beginAtZero: true, ticks: { precision: 0 } }
          }
        }
      });
    }

    function crearGraficoTemporal(data) {
      if (charts.temporal) charts.temporal.destroy();

      const ctx = document.getElementById('chartTemporal');
      
      // Ordenar por hora
      const horas = Object.keys(data).sort();
      const valores = horas.map(h => data[h]);

      // Calcular acumulado
      const acumulado = [];
      let suma = 0;
      valores.forEach(v => {
        suma += v;
        acumulado.push(suma);
      });

      charts.temporal = new Chart(ctx, {
        type: 'line',
        data: {
          labels: horas.map(h => h + ':00'),
          datasets: [{
            label: 'Votos acumulados',
            data: acumulado,
            borderColor: 'rgba(102, 126, 234, 1)',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { precision: 0 } }
          }
        }
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TABLA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function crearTabla(stats, total) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      // Crear array SOLO con fÃ³rmulas (Rector/Decanos)
      const candidatos = [];
      
      // Solo agregar fÃ³rmulas (no candidatos individuales de listas)
      for (const [nombre, votos] of Object.entries(stats.porAgrupacion)) {
        if (nombre && nombre.startsWith('FÃ³rmula')) {
          candidatos.push({ tipo: 'FÃ³rmula', nombre, votos });
        }
      }
      
      // Agregar listas completas si las hay
      for (const [nombre, votos] of Object.entries(stats.porListaCompleta)) {
        if (nombre && nombre !== '-') {
          candidatos.push({ tipo: 'Lista Completa', nombre, votos });
        }
      }

      // Ordenar por votos
      candidatos.sort((a, b) => b.votos - a.votos);

      // Mostrar todos los resultados
      candidatos.forEach(item => {
        const porcentaje = ((item.votos / total) * 100).toFixed(1);
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span style="background: ${item.tipo === 'FÃ³rmula' ? '#fff3e0' : '#e3f2fd'}; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${item.tipo}</span></td>
          <td><strong>${item.nombre}</strong></td>
          <td><strong>${item.votos}</strong></td>
          <td>${porcentaje}%</td>
          <td>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${Math.min(porcentaje, 100)}%"></div>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Si no hay datos
      if (candidatos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">No hay datos aÃºn</td></tr>';
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TABLA CRUZADA: LISTA x CARGO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function crearTablaCruzada(datosCruzados) {
      if (!datosCruzados || Object.keys(datosCruzados).length === 0) {
        document.getElementById('tableCruzadaBody').innerHTML = 
          '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #999;">No hay datos cruzados disponibles</td></tr>';
        return;
      }

      // Obtener todos los cargos Ãºnicos
      const cargosSet = new Set();
      Object.values(datosCruzados).forEach(agrupacion => {
        Object.keys(agrupacion).forEach(cargo => cargosSet.add(cargo));
      });
      const cargos = Array.from(cargosSet).sort();

      // Crear encabezados
      const thead = document.getElementById('tableCruzadaHead');
      const headerRow = thead.querySelector('tr');
      headerRow.innerHTML = '<th style="min-width: 150px; position: sticky; left: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 10;">Lista / AgrupaciÃ³n</th>';
      
      cargos.forEach(cargo => {
        const th = document.createElement('th');
        th.textContent = cargo;
        th.style.minWidth = '120px';
        headerRow.appendChild(th);
      });

      // Agregar columna de TOTAL
      const thTotal = document.createElement('th');
      thTotal.textContent = 'TOTAL';
      thTotal.style.fontWeight = 'bold';
      thTotal.style.background = '#f0f0f0';
      headerRow.appendChild(thTotal);

      // Crear filas
      const tbody = document.getElementById('tableCruzadaBody');
      tbody.innerHTML = '';

      const agrupaciones = Object.keys(datosCruzados).sort();

      agrupaciones.forEach(agrupacion => {
        const tr = document.createElement('tr');
        
        // Columna de nombre (sticky)
        const tdNombre = document.createElement('td');
        tdNombre.innerHTML = `<strong>${agrupacion}</strong>`;
        tdNombre.style.position = 'sticky';
        tdNombre.style.left = '0';
        tdNombre.style.background = 'white';
        tdNombre.style.zIndex = '5';
        tdNombre.style.borderRight = '2px solid #e0e0e0';
        tr.appendChild(tdNombre);

        let totalFila = 0;

        // Columnas de cargos
        cargos.forEach(cargo => {
          const td = document.createElement('td');
          const votos = datosCruzados[agrupacion][cargo] || 0;
          totalFila += votos;
          
          if (votos > 0) {
            td.innerHTML = `<strong style="color: #667eea;">${votos}</strong>`;
            td.style.background = `rgba(102, 126, 234, ${Math.min(votos / 20, 0.3)})`;
          } else {
            td.textContent = '-';
            td.style.color = '#ccc';
          }
          
          td.style.textAlign = 'center';
          tr.appendChild(td);
        });

        // Columna de total
        const tdTotal = document.createElement('td');
        tdTotal.innerHTML = `<strong style="color: #333; font-size: 16px;">${totalFila}</strong>`;
        tdTotal.style.textAlign = 'center';
        tdTotal.style.background = '#f8f9fa';
        tdTotal.style.fontWeight = 'bold';
        tr.appendChild(tdTotal);

        tbody.appendChild(tr);
      });

      // Fila de TOTALES por cargo
      const trTotal = document.createElement('tr');
      trTotal.style.borderTop = '3px solid #667eea';
      trTotal.style.background = '#f0f0f0';
      trTotal.style.fontWeight = 'bold';

      const tdTotalLabel = document.createElement('td');
      tdTotalLabel.innerHTML = '<strong>TOTAL POR CARGO</strong>';
      tdTotalLabel.style.position = 'sticky';
      tdTotalLabel.style.left = '0';
      tdTotalLabel.style.background = '#f0f0f0';
      tdTotalLabel.style.zIndex = '5';
      trTotal.appendChild(tdTotalLabel);

      let granTotal = 0;

      cargos.forEach(cargo => {
        const td = document.createElement('td');
        let totalCargo = 0;
        agrupaciones.forEach(agrupacion => {
          totalCargo += datosCruzados[agrupacion][cargo] || 0;
        });
        granTotal += totalCargo;
        td.innerHTML = `<strong>${totalCargo}</strong>`;
        td.style.textAlign = 'center';
        trTotal.appendChild(td);
      });

      const tdGranTotal = document.createElement('td');
      tdGranTotal.innerHTML = `<strong style="font-size: 18px; color: #667eea;">${granTotal}</strong>`;
      tdGranTotal.style.textAlign = 'center';
      tdGranTotal.style.background = '#e3f2fd';
      trTotal.appendChild(tdGranTotal);

      tbody.appendChild(trTotal);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GRÃFICO: LISTA x CARGO (Barras Agrupadas)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function crearGraficoListaPorCargo(datosCruzados) {
      if (charts.listaPorCargo) charts.listaPorCargo.destroy();

      const ctx = document.getElementById('chartListaPorCargo');

      if (!datosCruzados || Object.keys(datosCruzados).length === 0) {
        ctx.parentElement.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">No hay datos cruzados disponibles</p>';
        return;
      }

      // Obtener cargos Ãºnicos
      const cargosSet = new Set();
      Object.values(datosCruzados).forEach(agrupacion => {
        Object.keys(agrupacion).forEach(cargo => cargosSet.add(cargo));
      });
      const cargos = Array.from(cargosSet).sort();

      // Preparar datasets (uno por agrupaciÃ³n/lista)
      const agrupaciones = Object.keys(datosCruzados).sort();
      const colores = generarColores(agrupaciones.length);

      const datasets = agrupaciones.map((agrupacion, index) => {
        const data = cargos.map(cargo => datosCruzados[agrupacion][cargo] || 0);
        const bgColor = colores[index] || 'rgba(100, 100, 100, 0.8)'; // Color por defecto
        
        return {
          label: agrupacion,
          data: data,
          backgroundColor: bgColor,
          borderColor: bgColor.replace('0.8', '1'),
          borderWidth: 2
        };
      });

      charts.listaPorCargo = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: cargos,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                padding: 15,
                font: { size: 12, weight: 'bold' }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.parsed.y} votos`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45
              }
            },
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          }
        }
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILIDADES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function generarColores(cantidad) {
      const coloresBase = [
        'rgba(255, 99, 132, 0.8)',   // Rojo
        'rgba(54, 162, 235, 0.8)',   // Azul
        'rgba(255, 206, 86, 0.8)',   // Amarillo
        'rgba(75, 192, 192, 0.8)',   // Verde azulado
        'rgba(153, 102, 255, 0.8)',  // PÃºrpura
        'rgba(255, 159, 64, 0.8)',   // Naranja
        'rgba(199, 199, 199, 0.8)',  // Gris
        'rgba(83, 102, 255, 0.8)',   // Azul oscuro
        'rgba(255, 99, 255, 0.8)',   // Rosa
        'rgba(99, 255, 132, 0.8)',   // Verde claro
        'rgba(255, 159, 243, 0.8)',  // Rosa claro
        'rgba(159, 226, 255, 0.8)',  // Celeste
        'rgba(255, 219, 128, 0.8)',  // Amarillo claro
        'rgba(128, 255, 219, 0.8)',  // Turquesa
        'rgba(219, 128, 255, 0.8)'   // Violeta
      ];
      
      // Si necesitamos mÃ¡s colores, generarlos dinÃ¡micamente
      if (cantidad > coloresBase.length) {
        for (let i = coloresBase.length; i < cantidad; i++) {
          const r = Math.floor(Math.random() * 200) + 55;
          const g = Math.floor(Math.random() * 200) + 55;
          const b = Math.floor(Math.random() * 200) + 55;
          coloresBase.push(`rgba(${r}, ${g}, ${b}, 0.8)`);
        }
      }
      
      return coloresBase.slice(0, cantidad);
    }

    function mostrarLoading(mostrar) {
      document.getElementById('loadingDiv').classList.toggle('hidden', !mostrar);
    }

    function mostrarError(mensaje) {
      const div = document.getElementById('errorDiv');
      div.textContent = mensaje;
      div.classList.remove('hidden');
    }

    function mostrarSuccess(mensaje) {
      const div = document.getElementById('successDiv');
      div.textContent = mensaje;
      div.classList.remove('hidden');
      setTimeout(() => div.classList.add('hidden'), 3000);
    }

    function ocultarMensajes() {
      document.getElementById('errorDiv').classList.add('hidden');
      document.getElementById('successDiv').classList.add('hidden');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INICIALIZACIÃ“N
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    window.onload = function() {
      cargarConfiguracion();
      
      // Verificar si hay URL preconfigurada
      const urlConfigurada = SCRIPT_URL && SCRIPT_URL !== 'TU_URL_AQUI' && SCRIPT_URL.startsWith('http');
      
      if (urlConfigurada) {
        // Ocultar formulario de configuraciÃ³n y cargar datos automÃ¡ticamente
        document.getElementById('configCard').classList.add('hidden');
        cargarDatos();
      } else if (config.scriptUrl) {
        // Si hay URL en localStorage, cargar datos
        cargarDatos();
      } else {
        // Mostrar formulario de configuraciÃ³n
        document.getElementById('configCard').classList.remove('hidden');
      }

      // Auto-refresh cada 30 segundos si hay datos
      setInterval(() => {
        if (config.scriptUrl && !document.getElementById('statsSection').classList.contains('hidden')) {
          cargarDatos();
        }
      }, 30000);
    };
  </script>
</body>
</html>

